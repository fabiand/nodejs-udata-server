<!DOCTYPE html>
<html>
  <head>
    <title>Your List</title>
    <met charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
  <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body>

    <div class="container">
      <div class="row">
        <div class="span8">
            <legend>Not yet done</legend>
            <table id="tasks" class="table">
              <thead>
                <tr><td>
            <form class="form-inline"">
              <div class="input-append">
                <input id="task" type="text" class="span6" placeholder="Task"/>
                <button id="add-task" type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
                </td></tr>
              </thead>
              <tbody>
              </tbody>
            </table>
        </div>
      </div>
    </div>

    <script src="/assets/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/randomUUID.js" type="text/javascript"></script>
    <script src="/assets/udata.js"></script>
<script type="text/javascript;version=1.8">
$(document).ready(function() {
  var namespace = "com.example.nosql",
      apikey = "unused",
      form = $("form"),
      tasks = $("#tasks"),
      task = $("#task"),
      add_task = $("#add-task"),
      spinner = $("<i class='icon-spinner icon-spin icon-large'></i>");

  function successfunc(data) {
    console.log("Retrieved: " + data)
    $("#reply").text(JSON.stringify(data))
  }

  function errorfunc(err) {
    console.log("Error: " + JSON.stringify(err))
    console.log(err)
    $("#reply").text(err)
  }

  function cbfunc(err, data) {
    if (err) errorfunc(err)
    else successfunc(data)
  }

  var api = udata.API();

  var connection = api.create_connection("/", namespace, apikey, function(opts, cb) {
    opts.success = function(data) cb(undefined, data)
    opts.error = function(xhr, err, errt) cb(errt)
    $.ajax(opts)
  });

  var map = connection.map();

  form.submit(function() {
    console.log("Submit")
    add_task.attr("disabled", "disabled")
    add_task.html(spinner.clone());
    map.set(randomUUID(), task.val(), function(err) {
      task.val("");
      task.focus();
      add_task.removeAttr("disabled")
      add_task.text("Add")
    })
    return false; /* To prevent the default submission */
  })

  map.list(function(err, keys) {
    for(let idx in keys) {
      let key = keys[idx];
      map.get(key, function(err, val) {
        console.log(err, idx, key, val)
        showTask(key, val);
      })
    }
  })

  function showTask(key, val) {
    let row = $("<tr>").attr("id", key),
        col = $("<td>").text(val),
        btn = $("<button>").addClass("close").html("&times;"),
        col_btn = $("<td>");
    col_btn.append(btn);
    row.append(col).append(col_btn);
    tasks.find("tbody").append(row);
    btn.click(function() {
      btn.replaceWith(spinner.clone())
      map.delete(key, function(err) {
        console.log("deleted")
      });
    });
  }

  var evtSource = new EventSource("/api/event/request");
  evtSource.addEventListener("request", function(e) {
    let obj = JSON.parse(e.data)
    console.log("EVENT " + JSON.stringify(obj))

    let key = obj.url.split("/")[3];
    if (obj.method == "POST") {
      map.get(key, function(err, val) {
        console.log("add", key, val)
        showTask(key, val);
      })
    }
    if (obj.method == "DELETE") {
      console.log("del", key)
      tasks.find("#" + key).remove()
    }
  })

})
</script>

  </body>
</html>
