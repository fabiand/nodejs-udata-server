<!DOCTYPE html>
<html>
  <head>
    <title>Your List</title>
    <met charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="../assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="../assets/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body>

    <div class="container">
      <h1>Darling, remember â€¦</h1>
      <div class="row">
        <div class="span8">
          <div id="alert-target"></div>
          <table id="tasks" class="table">
            <thead>
              <tr>
                <th colspan="2">
                  <form>
                    <div class="input-group">
                      <input id="task" type="text" class="form-control" placeholder="Task" autocomplete="off"/>
                      <span class="input-group-btn">
                        <button id="add-task" type="submit" class="btn btn-primary">Add</button>
                      </span>
                    </div>
                  </form>
                </th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="../assets/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="../assets/udata.js"></script>
    <script src="randomUUID.js" type="text/javascript"></script>
    <script src="../assets/hmac.js" type="text/javascript"></script>
<script type="text/javascript;version=1.8">
$(document).ready(function() {
  var namespace = document.location.search || "com.example.nosql",
      apikey = "unused",
      form = $("form"),
      settings = $("#settings"),
      tasks = $("#tasks"),
      task = $("#task"),
      add_task = $("#add-task"),
      spinner = $("<i class='icon-spinner icon-spin icon-large'></i>"),
      alert_target = $("#alert-target");

  function showError(err) {
    console.log("Error: " + JSON.stringify(err))
    console.log(err)
    let alert = $("<div class='alert alert-danger'>");
    let dismiss_btn = $('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>')
    alert_target.append(alert.text(err))
    alert.append(dismiss_btn)
  }

  var api = udata.API();

  var connection = api.create_connection("/", namespace, function req_handler(opts, cb) {
    if (cb) {
      opts.success = function(data) cb(undefined, data)
      opts.error = function(xhr, err, errt) cb(errt, undefined)
    }
    $.ajax(opts)
  }, new function signer() {
    this.sign = function(data) {
        var hmac = makeHMAC()(apikey, data)
        console.log("SIgned with " + hmac)
        return hmac;
    }
  });


  /*
   * TodoList Model
   */
  var TodoList = function(connection) {
    console.log("Instantiatig new TodoList")

    this.map = connection.map();
    this.events = connection.pubsub().subscribe("todo-items");;
  }
  TodoList.EVENT_ADDED = "item-added"
  TodoList.EVENT_DELETED = "item-deleted"

  TodoList.prototype.items = function(callback) {
    console.log("Listing all TodoList items")
    var todolist = this
    this.map.list(function(err, keys) {
      if (err) callback(err)
      for(let idx in keys) {
        let key = keys[idx];
        todolist.item(key, function(err, val) {
          callback(err, key, val);
        })
      }
    })
  }

  TodoList.prototype.item = function(key, callback) {
    console.log("Getting one TodoList item")
    var todolist = this
    this.map.get(key, function(err, val) {
      callback(err, val)
    })
  }

  TodoList.prototype.add = function(task_desc, callback) {
    console.log("Adding new item to TodoList: " + task_desc)
    var todolist = this
    var key = randomUUID();
    this.map.set(key, task_desc, function(err) {
      callback(err, key)
      todolist.events.publish(TodoList.EVENT_ADDED, {key: key})
    })
  }

  TodoList.prototype.delete = function(key, callback) {
    console.log("Deleting a TodoList item: " + key)
    var todolist = this
    this.map.delete(key, function(err) {
      callback(err, key)
      todolist.events.publish(TodoList.EVENT_DELETED, {key: key})
    });
  }

  TodoList.prototype.on = function(eventname, callback) {
    console.log("Attaching new TodoList event: " + eventname)
    this.events.on(eventname, callback)
  }


  /*
   * UI Controller
   */
  var todolist = new TodoList(connection);

  form.submit(function() {
    console.log("Submit")
    if (!task.val()) {
      showError("Please enter a task")
      return false
    }
    add_task.attr("disabled", "disabled")
    add_task.html(spinner.clone());

    todolist.add(task.val(), function(err, key) {
      if (err) showError(err);
      task.val("");
      task.focus();
      add_task.removeAttr("disabled")
      add_task.text("Add")
    })
    return false; /* To prevent the default submission */
  })

  todolist.items(function(err, key, val) {
    console.log("reading item", err, key, val)
    if (err) showError(err);
    showTask(key, val);
  })

  function showTask(key, val) {
    let row = $("<tr>").attr("id", key),
        col = $("<td>").text(val),
        btn = $("<button class='close'>&times;</button>"),
        col_btn = $("<td>");
    col_btn.append(btn);
    row.append(col).append(col_btn);
    tasks.find("tbody").append(row);
    btn.click(function() {
      btn.replaceWith(spinner.clone().addClass("close"))
      todolist.delete(key, function(err) {
        console.log("deleted")
      });
    });
  }

  todolist.on(TodoList.EVENT_ADDED, function(e) {
    let obj = JSON.parse(e.data)
    console.log("ADDED " + JSON.stringify(obj))
    let key = obj.data.key
    console.log("KEY " + key)

    todolist.item(key, function(err, val) {
      console.log("add", key, val)
      showTask(key, val);
      (new Audio("glass.ogg")).play()
    })
  })

  todolist.on(TodoList.EVENT_DELETED, function(e) {
    let obj = JSON.parse(e.data)
    console.log("DEL " + JSON.stringify(obj))
    let key = obj.data.key
    console.log("KEY " + key)

    console.log("del", key)
    tasks.find("#" + key).remove()
  })

})
</script>

  </body>
</html>
