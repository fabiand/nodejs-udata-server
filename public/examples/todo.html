<!DOCTYPE html>
<html>
  <head>
    <title>Your List</title>
    <met charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
  <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body>

    <div class="container">
      <h1>Darling, remember â€¦</h1>
      <div class="row">
        <div class="span8">
          <div id="alert-target"></div>
          <table id="tasks" class="table">
            <thead>
              <tr>
                <th colspan="2">
                  <form>
                    <div class="input-group">
                      <input id="task" type="text" class="form-control" placeholder="Task"/>
                      <span class="input-group-btn">
                        <button id="add-task" type="submit" class="btn btn-primary">Add</button>
                      </span>
                    </div>
                  </form>
                </th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="/assets/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/randomUUID.js" type="text/javascript"></script>
    <script src="/assets/udata.js"></script>
<script type="text/javascript;version=1.8">
$(document).ready(function() {
  var namespace = document.location.search || "com.example.nosql",
      apikey = "unused",
      form = $("form"),
      settings = $("#settings"),
      tasks = $("#tasks"),
      task = $("#task"),
      add_task = $("#add-task"),
      spinner = $("<i class='icon-spinner icon-spin icon-large'></i>"),
      alert_target = $("#alert-target");

  function showError(err) {
    console.log("Error: " + JSON.stringify(err))
    console.log(err)
    let alert = $("<div class='alert alert-danger'>");
    let dismiss_btn = $('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>')
    alert_target.append(alert.text(err))
    alert.append(dismiss_btn)
  }

  var api = udata.API();

  var connection = api.create_connection("/", namespace, apikey, function(opts, cb) {
    if (cb) {
      opts.success = function(data) cb(undefined, data)
      opts.error = function(xhr, err, errt) cb(errt, undefined)
    }
    $.ajax(opts)
  });

  var map = connection.map();

  form.submit(function() {
    console.log("Submit")
    if (!task.val()) {
      showError("Please enter a task")
      return false
    }
    add_task.attr("disabled", "disabled")
    add_task.html(spinner.clone());
    map.set(randomUUID(), task.val(), function(err) {
      if (err) showError(err);
      task.val("");
      task.focus();
      add_task.removeAttr("disabled")
      add_task.text("Add")
    })
    return false; /* To prevent the default submission */
  })

  map.list(function(err, keys) {
    if (err) showError(err);
    for(let idx in keys) {
      let key = keys[idx];
      map.get(key, function(err, val) {
        console.log(err, idx, key, val)
        showTask(key, val);
      })
    }
  })

  function showTask(key, val) {
    let row = $("<tr>").attr("id", key),
        col = $("<td>").text(val),
        btn = $("<button class='close'>&times;</button>"),
        col_btn = $("<td class='close'>");
    col_btn.append(btn);
    row.append(col).append(col_btn);
    tasks.find("tbody").append(row);
    btn.click(function() {
      btn.replaceWith(spinner.clone())
      map.delete(key, function(err) {
        console.log("deleted")
      });
    });
  }

  function playSound(isnew) {
    /* Shamelessly taken from GNOME 3 */
    let audio = new Audio("/assets/glass.ogg")
    audio.play()
  }

  var evtSource = new EventSource("/api/event/request");
  evtSource.addEventListener("request", function(e) {
    let obj = JSON.parse(e.data)
    console.log("EVENT " + JSON.stringify(obj))

    let key = obj.url.split("/")[3];
    if (obj.method == "POST") {
      map.get(key, function(err, val) {
        console.log("add", key, val)
        showTask(key, val);
        playSound();
      })
    }
    if (obj.method == "DELETE") {
      console.log("del", key)
      tasks.find("#" + key).remove()
    }
  })

})
</script>

  </body>
</html>
